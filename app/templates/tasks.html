<!doctype html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–æ–¥–∞</title>
    <style>
        /* CSS –æ—Å—Ç–∞–µ—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
            color: #333;
        }

        .task-container {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
            padding: 20px;
            border-left: 5px solid #3498db;
        }

        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
            margin-bottom: 15px;
            cursor: pointer;
        }

        .task-id {
            font-weight: bold;
            color: #3498db;
            font-family: monospace;
            font-size: 1.1em;
        }

        .task-status {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: bold;
        }

        .status-completed {
            background-color: #2ecc71;
            color: white;
        }

        .status-processing {
            background-color: #f39c12;
            color: white;
        }

        .status-failed {
            background-color: #e74c3c;
            color: white;
        }

        .task-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }

        .task-content.show {
            max-height: 10000px;
            transition: max-height 1s ease-in;
        }

        .error-summary {
            font-weight: bold;
            font-size: 1.1em;
            margin: 15px 0 10px 0;
            color: #2c3e50;
        }

        .error-group {
            margin-bottom: 20px;
            border-left: 4px solid #e74c3c;
            background-color: #f8f9fa;
            padding: 10px 15px;
            border-radius: 5px;
        }

        .error-type {
            font-weight: bold;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid #e0e0e0;
        }

        .error-item {
            margin: 8px 0;
            padding: 10px;
            background-color: #fff;
            border-radius: 4px;
            border: 1px solid #e0e0e0;
        }

        .file-name {
            color: #2980b9;
            font-weight: bold;
        }

        .line-number {
            color: #e74c3c;
            font-weight: bold;
        }

        .error-description {
            margin-top: 3px;
        }

        .circle-icon {
            display: inline-block;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background-color: #e74c3c;
            margin-right: 8px;
            vertical-align: middle;
        }

        .toggle-icon {
            margin-right: 10px;
            transition: transform 0.3s;
            display: inline-block;
        }

        .rotate {
            transform: rotate(90deg);
        }

        .task-content>* {
            margin-top: 10px;
        }

        .task-content.show {
            padding-top: 10px;
        }

        /* –î–æ–±–∞–≤–∏–º —Å—Ç–∏–ª—å –¥–ª—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –∑–∞–≥—Ä—É–∑–∫–∏ */
        #loading {
            text-align: center;
            padding: 20px;
            font-size: 1.2em;
            color: #3498db;
        }
    </style>
</head>

<body>
    <div id="loading">–ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤...</div>
    <div id="tasks-container">
        <!-- –ó–¥–µ—Å—å –±—É–¥—É—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –∑–∞–¥–∞—á–∏, –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ API -->
    </div>

    <script>
        


        // –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ API
        async function loadTasks() {
            try {
                const response = await fetch('/api/tasks');

                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }

                const data = await response.json();

                // –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
                document.getElementById('loading').style.display = 'none';

                // –†–µ–Ω–¥–µ—Ä–∏–º –ø–æ–ª—É—á–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
                renderTasks(data);
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∑–∞–¥–∞—á:', error);
                document.getElementById('loading').textContent =
                    '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.';
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∑–∞–¥–∞—á –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
        function renderTasks(tasksData) {
            const container = document.getElementById('tasks-container');

            // –û—á–∏—â–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø–µ—Ä–µ–¥ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º –Ω–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö
            container.innerHTML = '';

            // –ü–µ—Ä–µ–±–∏—Ä–∞–µ–º –≤—Å–µ –∑–∞–¥–∞—á–∏ –∏ —Å–æ–∑–¥–∞–µ–º –¥–ª—è –Ω–∏—Ö HTML-—ç–ª–µ–º–µ–Ω—Ç—ã
            for (const [taskId, taskDescription] of Object.entries(tasksData)) {
                const taskElement = createTaskElement(taskId, taskDescription);
                container.prepend(taskElement);
            }
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–∞ –¥–ª—è –æ—Ç–¥–µ–ª—å–Ω–æ–π –∑–∞–¥–∞—á–∏
        function createTaskElement(taskId, taskDescription) {
            const taskContainer = document.createElement('div');
            taskContainer.className = 'task-container';

            // –°–æ–∑–¥–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∑–∞–¥–∞—á–∏
            const taskHeader = document.createElement('div');
            taskHeader.className = 'task-header';
            taskHeader.onclick = function () { toggleContent(this); };

            const taskIdDiv = document.createElement('div');
            taskIdDiv.className = 'task-id';
            taskIdDiv.innerHTML = `<span class="toggle-icon">‚ñ∂</span>ID: ${taskId}`;

            const taskStatus = document.createElement('div');
            taskStatus.className = `task-status status-${taskDescription.status}`;
            taskStatus.textContent = taskDescription.status;

            taskHeader.appendChild(taskIdDiv);
            taskHeader.appendChild(taskStatus);
            taskContainer.appendChild(taskHeader);

            if (taskDescription.status !== "processing") {
                const taskContent = document.createElement('div');
                taskContent.className = 'task-content';

                const contentWrapper = document.createElement('div');
                contentWrapper.className = 'content-wrapper';

                if (taskDescription.result) {
                    const lines = taskDescription.result;
                    let errorGroupOpen = false;

                    lines.forEach(line => {
                        if (line.includes('–í —Ñ–∞–π–ª–µ –Ω–∞–π–¥–µ–Ω–æ')) {
                            const errorSummary = document.createElement('div');
                            errorSummary.className = 'error-summary';
                            errorSummary.textContent = line;
                            contentWrapper.appendChild(errorSummary);
                        }
                        else if (line.includes('üõë –û—à–∏–±–∫–∞:')) {
                            if (errorGroupOpen) {
                                // –ó–∞–∫—Ä—ã–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â—É—é –≥—Ä—É–ø–ø—É –æ—à–∏–±–æ–∫
                                errorGroupOpen = false;
                            }

                            const errorGroup = document.createElement('div');
                            errorGroup.className = 'error-group';

                            const errorType = document.createElement('div');
                            errorType.className = 'error-type';
                            errorType.innerHTML = '<span class="circle-icon"></span>' +
                                line.replace('üõë –û—à–∏–±–∫–∞:', '–û—à–∏–±–∫–∞:');

                            errorGroup.appendChild(errorType);
                            contentWrapper.appendChild(errorGroup);
                            errorGroupOpen = true;
                        }
                        else if (line.includes('–§–∞–π–ª:')) {
                            const errorItem = document.createElement('div');
                            errorItem.className = 'error-item';
                            errorItem.innerHTML = line
                                .replace('–§–∞–π–ª:', '<span class="file-name">–§–∞–π–ª:</span>')
                                .replace('—Å—Ç—Ä–æ–∫–∞:', '<span class="line-number">—Å—Ç—Ä–æ–∫–∞:</span>')
                                .replace('–û–ø–∏—Å–∞–Ω–∏–µ:', '<br><span class="error-description">–û–ø–∏—Å–∞–Ω–∏–µ:</span>');

                            // –î–æ–±–∞–≤–ª—è–µ–º —ç–ª–µ–º–µ–Ω—Ç –≤ –ø–æ—Å–ª–µ–¥–Ω—é—é —Å–æ–∑–¥–∞–Ω–Ω—É—é –≥—Ä—É–ø–ø—É –æ—à–∏–±–æ–∫
                            const errorGroups = contentWrapper.querySelectorAll('.error-group');
                            if (errorGroups.length > 0) {
                                errorGroups[errorGroups.length - 1].appendChild(errorItem);
                            } else {
                                contentWrapper.appendChild(errorItem);
                            }
                        }
                        else if (line.trim()) {
                            const paragraph = document.createElement('p');
                            paragraph.textContent = line;
                            contentWrapper.appendChild(paragraph);
                        }
                    });
                }

                taskContent.appendChild(contentWrapper);
                taskContainer.appendChild(taskContent);
            }

            return taskContainer;
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è/—Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞
        function toggleContent(header) {
            const contentDiv = header.nextElementSibling;
            const toggleIcon = header.querySelector('.toggle-icon');

            if (contentDiv && contentDiv.classList.contains('task-content')) {
                contentDiv.classList.toggle('show');
                toggleIcon.classList.toggle('rotate');
            }
        }

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ–º –∑–∞–¥–∞—á–∏ —Å –ø—Ä–æ–≤–∞–ª–µ–Ω–Ω—ã–º —Å—Ç–∞—Ç—É—Å–æ–º
        function goida(){
            const urlParams = new URLSearchParams(window.location.search);
    const currentTaskId = urlParams.get("taskId");
    for (let element of document.getElementsByClassName("task-header")) {
        if (element.outerText.includes(`${currentTaskId}`)) {
                element.click();
            }
        }

        }
        let pollingInterval;

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –∑–∞–¥–∞—á–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', () => {
            loadTasks().then(() => {
                goida();
            });
            
        });
    </script>
</body>

</html>